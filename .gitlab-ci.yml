# Minecraft Docker Builder
# GitLab CI/CD configuration

stages:
  - test
  - build-cli
  - create-image

variables:
  CLI_IMAGE_NAME: "rdall96/minecraft-docker"
  RELEASE_TAG: '/^\d.\d.\d$/'
  # Use TLS https://docs.gitlab.com/ee/ci/docker/using_docker_build.html#tls-enabled
  DOCKER_HOST: tcp://docker:2376
  DOCKER_TLS_CERTDIR: "/certs"
  # Tag to use when building images
  CLI_IMAGE_TAG: "latest"

default:
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

# Build the CLI for testing
cli-build:
  stage: test
  script:
    - docker build -t $CI_REGISTRY/$CLI_IMAGE_NAME:$CI_COMMIT_SHORT_SHA .
    - docker run --rm $CI_REGISTRY/$CLI_IMAGE_NAME:$CI_COMMIT_SHORT_SHA --help
  rules:
    # only run this job for merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  tags:
    - tools

# Build the CLI for release
release-cli-build:
  stage: build-cli
  script:
    - |
      docker build -t $CI_REGISTRY/$CLI_IMAGE_NAME:$CI_COMMIT_TAG . \
      --build-arg CLI_VERSION=$CI_COMMIT_TAG
    - docker push $CI_REGISTRY/$CLI_IMAGE_NAME:$CI_COMMIT_TAG
    - docker tag $CI_REGISTRY/$CLI_IMAGE_NAME:$CI_COMMIT_TAG $CI_REGISTRY/$CLI_IMAGE_NAME:latest
    - docker push $CI_REGISTRY/$CLI_IMAGE_NAME:latest
  rules:
    # only run this job when a new release tag is created
    - if: $CI_COMMIT_TAG =~ $RELEASE_TAG
  tags:
    - tools

# Build the CLI for debugging
dev-cli-build:
  stage: build-cli
  script:
    - |
      docker build -t $CI_REGISTRY/$CLI_IMAGE_NAME:dev-$CI_COMMIT_SHORT_SHA . \
      --build-arg CLI_VERSION=dev-$CI_COMMIT_SHORT_SHA \
      --build-arg BUILD_TYPE=debug
    - docker push $CI_REGISTRY/$CLI_IMAGE_NAME:dev-$CI_COMMIT_SHORT_SHA
  rules:
    # only run this job when a new commit is created and we don't have a tag
    - if: $CI_COMMIT_TAG =~ $RELEASE_TAG
      when: never
    # allow build tagging in merge requests (optional)
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
    # and if we have changes in relevant files when pushing a new commit
    - if: $CI_PIPELINE_SOURCE == "push"
      changes:
        - Dockerfile
        - Sources/**/*
        - Package.*
      when: always
  tags:
    - tools


# Scheduled builds

minecraft-server:
  stage: create-image
  script:
    - echo "Building Docker image for $MINECRAFT_TYPE Minecraft version $MINECRAFT_VERSION"
    - docker pull $CI_REGISTRY/$CLI_IMAGE_NAME:$CLI_IMAGE_TAG
    # Logout from GitLab registry
    - docker logout $CI_REGISTRY
    # Print out the version being used
    - |
      docker run --rm \
      -v /var/run/docker.sock:/var/run/docker.sock \
      $CI_REGISTRY/$CLI_IMAGE_NAME:$CLI_IMAGE_TAG \
      version
    # Run the build
    - |
      docker run --rm \
      -v /var/run/docker.sock:/var/run/docker.sock \
      $CI_REGISTRY/$CLI_IMAGE_NAME:$CLI_IMAGE_TAG \
      build -t $MINECRAFT_TYPE -v $MINECRAFT_VERSION \
      --push -u $MINECRAFT_SERVER_REPOSITORY_USERNAME -p $MINECRAFT_SERVER_REPOSITORY_PASSWORD \
      --clean
  rules:
    - if: $MINECRAFT_VERSION == null || $MINECRAFT_VERSION == ""
      when: never
    - if: $CI_PIPELINE_SOURCE == "schedule" || $CI_PIPELINE_SOURCE == "web"
  tags:
    - build
